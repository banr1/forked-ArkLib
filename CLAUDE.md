# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

ArkLib is a Lean 4 formal verification library for **succinct non-interactive arguments of knowledge** (SNARKs). The project formalizes Interactive Oracle Reductions (IORs) - the information-theoretic core of modern SNARKs - and proves completeness and soundness for various cryptographic protocols.

**Key Dependencies:**
- Lean 4 (v4.22.0)
- mathlib4 (Lean mathematics library)
- VCVio (v4.22.0) - Verification-Centric View of Interactive Oracle proofs
- Lake (Lean build system)

## Build Commands

### Building the Project
```bash
# Build the entire project
lake build

# Alternative: use the build script
./scripts/build-project.sh
```

### Linting
```bash
# Run style linter (Python-based)
./scripts/lint-style.sh

# Check if ArkLib.lean imports are up to date
./scripts/check-imports.sh
```

### Library Maintenance
```bash
# Update ArkLib.lean with all imports from source files
./scripts/update-lib.sh
```

### Documentation
```bash
# Generate documentation (doc-gen4 is a dependency)
lake build «doc-gen4»
```

## Architecture

### Core Theory: Interactive Oracle Reductions (IORs)

The foundation of ArkLib is located in `ArkLib/OracleReduction/`:

- **OracleReduction**: Interactive protocols between prover and verifier to reduce a relation R₁ (on public statement & private witness) to another relation R₂
- **Oracle Interface**: Verifier queries prover messages via oracle interface (e.g., vector queries, polynomial evaluations)
- **Sequential Composition**: Multiple IORs with compatible relations can be composed (R₁ → R₂ → R₃)
- **Lifting**: Transform IORs from simple contexts into larger, more complex contexts (virtual oracle reductions)
- **BCS Transform**: Materializes message oracles using functional commitment schemes (interactive BCS)
- **Fiat-Shamir Transform**: Collapses interaction via hash function queries (duplex-sponge version)

Key subdirectories in `OracleReduction/`:
- `ProtocolSpec/` - Protocol specification definitions
- `Security/` - Security notions (completeness, soundness)
- `Execution.lean` - IOR execution semantics
- `BCS/` - BCS transformation
- `FiatShamir/` - Fiat-Shamir transformation
- `Composition/` - Sequential composition proofs
- `LiftContext/` - Context lifting

### Proof Systems

`ArkLib/ProofSystem/` contains formalizations of specific cryptographic protocols:

- **Sumcheck/** - Sum-check protocol
- **Spartan/** - Spartan SNARK
- **Fri/** - FRI (Fast Reed-Solomon Interactive Oracle Proof)
- **Stir/** - STIR protocol
- **Whir/** - WHIR protocol
- **Binius/** - Binius
- **Plonk/** - Plonk constraint system
- **ConstraintSystem/** - Various constraint systems (R1CS, Lookup, MemoryChecking)

### Supporting Libraries

- **ArkLib/Data/** - Data structures and mathematical foundations
  - `CodingTheory/` - Reed-Solomon, Reed-Muller codes, list decodability, Berlekamp-Welch, Guruswami-Sudan
  - `FieldTheory/` - Binary field towers, additive NTT
  - `EllipticCurve/` - BN254 curve
  - `Classes/` - Type classes (HasSize, Serde, etc.)

- **ArkLib/CommitmentScheme/** - Commitment scheme implementations
  - Merkle trees (inductive and standard)
  - KZG commitments
  - Tensor commitments

- **ArkLib/ToMathlib/** - Utilities and lemmas intended for eventual upstreaming to mathlib
- **ArkLib/ToVCVio/** - Utilities for VCVio integration
- **ArkLib/AGM/** - Algebraic Group Model

### File Organization

- `ArkLib.lean` - Root import file that imports all library modules (auto-generated by `update-lib.sh`)
- `lakefile.toml` - Lake build configuration
- `lean-toolchain` - Specifies Lean version (v4.22.0)
- `scripts/` - Build, lint, and analysis utilities

## Development Workflow

### Adding New Modules

1. Create your `.lean` file in the appropriate subdirectory under `ArkLib/`
2. Run `./scripts/update-lib.sh` to update `ArkLib.lean` with the new import
3. Verify imports with `./scripts/check-imports.sh`

### Style Guidelines

ArkLib follows the [mathlib Style Guide](https://github.com/leanprover-community/mathlib4/blob/master/CONTRIBUTING.md). Key points:

- Run `./scripts/lint-style.sh` before committing
- Add copyright header to all files
- Include module docstrings
- Line length ≤ 100 characters (unless URL)
- Follow mathlib naming conventions
- Disable autoImplicit (configured in lakefile.toml)

### Working with Dependencies

- **VCVio** is developed in parallel with ArkLib - updates may be required if VCVio changes
- **mathlib** is the standard Lean mathematics library - try to use existing lemmas before proving new ones
- Contributions to `ToMathlib/` are candidates for upstreaming to mathlib

### Blueprints

For substantial contributions (new proof systems), develop a [blueprint](https://github.com/PatrickMassot/leanblueprint) first:
- Outline formalization contents and strategy
- Create dependency graph of intermediate results
- Reference relevant literature
- Discuss with maintainers before implementation

See `blueprint/` directory for examples.

## Common Patterns

### Protocol Definitions

Protocols are typically structured as:
1. Type definitions for statements, witnesses, oracles
2. Protocol specification (message structure, rounds)
3. Prover and verifier implementations
4. Completeness proof
5. Soundness proof (often round-by-round knowledge soundness)

### Composition and Modularity

ArkLib emphasizes building complex protocols from simpler components:
- Define base components (e.g., zero check, permutation check)
- Use sequential composition to combine components
- Lift components to larger contexts as needed
- Derive security from component security properties

Example: Plonk is constructed from sub-routines and its security is derived via composition theorems.

## CI and Automation

- **CI workflow** (`ci.yml`): Runs on PRs to main branch, builds the project (linting currently disabled)
- **Import checking** (`check-imports.yml`): Verifies `ArkLib.lean` is up to date
- **Documentation** (`docs.yml`): Generates and publishes documentation
- **PR summary** (`pr-summary.yml`): Generates PR summaries

## Active Development Areas

Current active formalizations (as of README):
- Sum-Check Protocol
- Spartan
- Merkle Trees
- FRI and coding theory prerequisites
- STIR and WHIR
- Binius

## Notes

- The repository uses the Apache 2.0 license
- All contributions must align with the license terms
- The project follows mathlib's Code of Conduct
- Releases align with Lean and mathlib stable release cycles
- VCVio refactoring may affect prover type definitions (see comments in `OracleReduction/Basic.lean`)
